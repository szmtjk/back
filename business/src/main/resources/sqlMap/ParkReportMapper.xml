<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.xingyi.logistic.db.dao.ParkReportDao">
    <!--auto generated Code-->
    <resultMap id="dayReportColumnMap" type="com.xingyi.logistic.db.dataobject.park.ParkReportDayDO">
        <result column="park_date" property="parkDate"/>
        <result column="amount" property="amount"/>
        <result column="free_count" property="freeCount"/>
        <result column="paid_count" property="paidCount"/>
        <result column="prepay_amount" property="prepayAmount"/>
        <result column="prepay_count" property="prepayCount"/>
        <result column="post_amount" property="postAmount"/>
        <result column="post_count" property="postCount"/>
        <result column="total_amount" property="totalAmount"/>
    </resultMap>

    <resultMap id="monthReportColumnMap" type="com.xingyi.logistic.db.dataobject.park.ParkReportMonthDO">
        <result column="park_date" property="parkDate"/>
        <result column="total_amount" property="totalAmount"/>
        <result column="free_count" property="freeCount"/>
        <result column="paid_count" property="paidCount"/>
    </resultMap>

    <select id="queryDayReportCount" resultType="java.lang.Integer" parameterType="Map" >
        SELECT  count(1)
        FROM <include refid="queryDReportComm"/>
    </select>

    <select id="queryMonthReportCount" resultType="java.lang.Integer" parameterType="Map" >
        SELECT  count(1)
        FROM <include refid="queryMReportComm"/>
    </select>

    <select id="queryDayReport" resultMap="dayReportColumnMap" parameterType="Map" >
        SELECT  *
        FROM  <include refid="queryDReportComm"/>
        order by `park_date`
        <include refid="pageCommon"/>
    </select>

    <select id="queryMonthReport" resultMap="monthReportColumnMap" parameterType="Map" >
        SELECT  *
        FROM  <include refid="queryMReportComm"/>
        order by `park_date`
        <include refid="pageCommon"/>
    </select>

    <sql id="queryMReportComm">
        (
        select date_format(a.park_date, '%Y-%m') as park_date, sum(a.total_amount) as total_amount,
               sum(a.paid_count) as paid_count, sum(a.free_count) as free_count
        from <include refid="queryDReportComm" />
        group by date_format(a.park_date, '%Y-%m')
        ) b
    </sql>

    <sql id="queryDReportComm">
        (
        select aa.gtz_d as park_date, gtz_c as paid_count, case when zero_c > 0 then zero_c else 0 end as free_count, amount,
               case when cc.prepay_amount > 0 then cc.prepay_amount else 0 end as prepay_amount,
               case when cc.prepay_count > 0 then cc.prepay_count else 0 end as prepay_count,
               case when dd.post_amount > 0 then dd.post_amount else 0 end as post_amount,
               case when dd.post_count > 0 then dd.post_count else 0 end as post_count,
               (amount + case when cc.prepay_amount > 0 then cc.prepay_amount else 0 END
                       + case when dd.post_amount > 0 then dd.post_amount else 0 end) as total_amount
        from (select park_date as gtz_d, count(1) as gtz_c, sum(amount) as amount
              from park_history
              where flag=1 and account_flag = 0 and amount &gt; 0
                <if test="pojo.startDate != null"> and `park_date` &gt;= #{pojo.startDate} </if>
                <if test="pojo.endDate != null"> and `park_date` &lt;= #{pojo.endDate} </if>
              group by park_date
             ) aa
        left join
             (select park_date as zero_d, count(1) as zero_c
              from park_history
              where flag=1 and account_flag = 0 and amount = 0
                <if test="pojo.startDate != null"> and `park_date` &gt;= #{pojo.startDate} </if>
                <if test="pojo.endDate != null"> and `park_date` &lt;= #{pojo.endDate} </if>
              group by park_date
             ) bb on bb.zero_d = aa.gtz_d
        left join
             (select account_date as pd, sum(amount) as prepay_amount, count(1) as prepay_count
              from park_account
              where flag=1
                  <if test="pojo.startDate != null"> and `account_date` &gt;= #{pojo.startDate} </if>
                  <if test="pojo.endDate != null"> and `account_date` &lt;= #{pojo.endDate} </if>
              group by account_date
             ) cc on cc.pd = aa.gtz_d
        left join
             (select account_date as pd, sum(amount) as post_amount, count(1) as post_count
              from park_account
              where flag=2
                  <if test="pojo.startDate != null"> and `account_date` &gt;= #{pojo.startDate} </if>
                  <if test="pojo.endDate != null"> and `account_date` &lt;= #{pojo.endDate} </if>
              group by account_date
            ) dd on dd.pd = aa.gtz_d
        ) a
    </sql>

    <sql id="pageCommon">
        <if test="pojo.start != null and pojo.start gt -1 and pojo.limit != null and pojo.limit gt 0">
            limit #{pojo.start}, #{pojo.limit}
        </if>
    </sql>

</mapper>

